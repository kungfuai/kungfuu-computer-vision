
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Project 2: A minimal model training experiment &#8212; Evolve model training recipes for image classification</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Project 1: Preparing an image dataset for model training" href="p1_dataset.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Evolve model training recipes for image classification</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="p1_dataset.html">
   Project 1: Preparing an image dataset for model training
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Project 2: A minimal model training experiment
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://colab.research.google.com/github/kungfuai/kungfu-computer-vision/blob/main/course1-image-classification/p2_training.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/kungfuai/kungfu-computer-vision"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/kungfuai/kungfu-computer-vision/issues/new?title=Issue%20on%20page%20%2Fp2_training.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/p2_training.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-create-a-model-using-lightningmodule">
   Step 1: Create a model using
   <code class="docutils literal notranslate">
    <span class="pre">
     LightningModule
    </span>
   </code>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing-the-forward-path-of-the-model">
     Testing the forward path of the model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#what-is-a-valid-input">
       What is a valid input?
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-prepare-the-dataset-and-data-loader">
   Step 2: Prepare the dataset and data loader
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-3-training-the-model">
   Step 3: Training the model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loss">
     Loss
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimizer">
     Optimizer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-step">
     Training Step
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#metrics">
     Metrics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-loop">
     Training loop
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-training">
     Model training
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-model-predictions">
   Visualize model predictions
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Project 2: A minimal model training experiment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-create-a-model-using-lightningmodule">
   Step 1: Create a model using
   <code class="docutils literal notranslate">
    <span class="pre">
     LightningModule
    </span>
   </code>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing-the-forward-path-of-the-model">
     Testing the forward path of the model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#what-is-a-valid-input">
       What is a valid input?
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-prepare-the-dataset-and-data-loader">
   Step 2: Prepare the dataset and data loader
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-3-training-the-model">
   Step 3: Training the model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loss">
     Loss
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimizer">
     Optimizer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-step">
     Training Step
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#metrics">
     Metrics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-loop">
     Training loop
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-training">
     Model training
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-model-predictions">
   Visualize model predictions
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="project-2-a-minimal-model-training-experiment">
<h1>Project 2: A minimal model training experiment<a class="headerlink" href="#project-2-a-minimal-model-training-experiment" title="Permalink to this headline">#</a></h1>
<p><strong>Goal</strong>:</p>
<ul class="simple">
<li><p>Create a <a class="reference external" href="https://pytorch-lightning.readthedocs.io/en/stable/common/lightning_module.html">PyTorch LightningModule</a> named <code class="docutils literal notranslate"><span class="pre">ImageClassifier</span></code> that holds a convolutional network with ResNet18 backbone.</p></li>
<li><p>Learn to adapt the dataset class to be compatible with the model.</p></li>
<li><p>Understand a minimal set of components of a model training pipeline: loss, optimizer, metrics, training loop.</p></li>
<li><p>Assemble the components to train a model using the dataset class and the dataloader created in the previous object.</p></li>
<li><p>Learn how to visualize model predictions.</p></li>
<li><p>Understand the concept of fine-tuning and the benefits of starting from a pre-trained model. (may move to the next project)</p></li>
<li><p>Understand the benefits and options of a dataloader. (may move to the next project)</p></li>
</ul>
<p><strong>Acceptance Criteria</strong>:</p>
<ul class="simple">
<li><p>Implement a test that checks a simple <code class="docutils literal notranslate"><span class="pre">ImageClassifier</span></code> can be predict on an image that has the correct shape.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ImageClassifier</span></code> can be trained on the CIFAR10 dataset, showing decreasing loss and accuracy for several epochs.</p></li>
</ul>
<section id="step-1-create-a-model-using-lightningmodule">
<h2>Step 1: Create a model using <code class="docutils literal notranslate"><span class="pre">LightningModule</span></code><a class="headerlink" href="#step-1-create-a-model-using-lightningmodule" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">LightningModule</span></code> is a convenient and structured way to implement a PyTorch model, as well as its training and validation behaviors. For more information, please refer to the <a class="reference external" href="https://pytorch-lightning.readthedocs.io/en/stable/common/lightning_module.html">documentation</a> for <code class="docutils literal notranslate"><span class="pre">LightningModule</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install the dependencies:</span>
<span class="o">!</span>pip install <span class="nv">torch</span><span class="o">==</span><span class="m">1</span>.12.0 <span class="nv">torchvision</span><span class="o">==</span><span class="m">0</span>.13.0 pytorch-lightning<span class="o">==</span><span class="m">1</span>.6.4 torchmetrics
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: torch==1.12.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (1.12.0)
Requirement already satisfied: torchvision==0.13.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (0.13.0)
Requirement already satisfied: pytorch-lightning==1.6.4 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (1.6.4)
Requirement already satisfied: torchmetrics in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (0.9.2)
Requirement already satisfied: typing-extensions in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from torch==1.12.0) (4.3.0)
Requirement already satisfied: requests in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from torchvision==0.13.0) (2.28.1)
Requirement already satisfied: numpy in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from torchvision==0.13.0) (1.23.1)
Requirement already satisfied: pillow!=8.3.*,&gt;=5.3.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from torchvision==0.13.0) (9.2.0)
Requirement already satisfied: fsspec[http]!=2021.06.0,&gt;=2021.05.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (2022.5.0)
Requirement already satisfied: tqdm&gt;=4.57.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (4.64.0)
Requirement already satisfied: packaging&gt;=17.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (21.3)
Requirement already satisfied: protobuf&lt;=3.20.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (3.19.4)
Requirement already satisfied: tensorboard&gt;=2.2.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (2.9.1)
Requirement already satisfied: pyDeprecate&gt;=0.3.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (0.3.2)
Requirement already satisfied: PyYAML&gt;=5.4 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pytorch-lightning==1.6.4) (6.0)
Requirement already satisfied: aiohttp in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (3.8.1)
Requirement already satisfied: pyparsing!=3.0.5,&gt;=2.0.2 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from packaging&gt;=17.0-&gt;pytorch-lightning==1.6.4) (3.0.9)
Requirement already satisfied: markdown&gt;=2.6.8 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (3.3.7)
Requirement already satisfied: google-auth-oauthlib&lt;0.5,&gt;=0.4.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (0.4.6)
Requirement already satisfied: werkzeug&gt;=1.0.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (2.1.2)
Requirement already satisfied: google-auth&lt;3,&gt;=1.6.3 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (2.9.0)
Requirement already satisfied: setuptools&gt;=41.0.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (61.2.0)
Requirement already satisfied: tensorboard-data-server&lt;0.7.0,&gt;=0.6.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (0.6.1)
Requirement already satisfied: tensorboard-plugin-wit&gt;=1.6.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (1.8.1)
Requirement already satisfied: grpcio&gt;=1.24.3 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (1.47.0)
Requirement already satisfied: absl-py&gt;=0.4 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (1.1.0)
Requirement already satisfied: wheel&gt;=0.26 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (0.37.1)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from requests-&gt;torchvision==0.13.0) (3.3)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from requests-&gt;torchvision==0.13.0) (1.26.10)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from requests-&gt;torchvision==0.13.0) (2.1.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from requests-&gt;torchvision==0.13.0) (2022.6.15)
Requirement already satisfied: cachetools&lt;6.0,&gt;=2.0.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (5.2.0)
Requirement already satisfied: rsa&lt;5,&gt;=3.1.4 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (4.8)
Requirement already satisfied: pyasn1-modules&gt;=0.2.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (0.2.8)
Requirement already satisfied: six&gt;=1.9.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (1.16.0)
Requirement already satisfied: requests-oauthlib&gt;=0.7.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from google-auth-oauthlib&lt;0.5,&gt;=0.4.1-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (1.3.1)
Requirement already satisfied: importlib-metadata&gt;=4.4 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from markdown&gt;=2.6.8-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (4.12.0)
Requirement already satisfied: async-timeout&lt;5.0,&gt;=4.0.0a3 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from aiohttp-&gt;fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (4.0.2)
Requirement already satisfied: attrs&gt;=17.3.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from aiohttp-&gt;fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (21.4.0)
Requirement already satisfied: yarl&lt;2.0,&gt;=1.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from aiohttp-&gt;fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (1.7.2)
Requirement already satisfied: aiosignal&gt;=1.1.2 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from aiohttp-&gt;fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (1.2.0)
Requirement already satisfied: multidict&lt;7.0,&gt;=4.5 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from aiohttp-&gt;fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (6.0.2)
Requirement already satisfied: frozenlist&gt;=1.1.1 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from aiohttp-&gt;fsspec[http]!=2021.06.0,&gt;=2021.05.0-&gt;pytorch-lightning==1.6.4) (1.3.0)
Requirement already satisfied: zipp&gt;=0.5 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from importlib-metadata&gt;=4.4-&gt;markdown&gt;=2.6.8-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (3.8.0)
Requirement already satisfied: pyasn1&lt;0.5.0,&gt;=0.4.6 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from pyasn1-modules&gt;=0.2.1-&gt;google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (0.4.8)
Requirement already satisfied: oauthlib&gt;=3.0.0 in /Users/zzsi/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages (from requests-oauthlib&gt;=0.7.0-&gt;google-auth-oauthlib&lt;0.5,&gt;=0.4.1-&gt;tensorboard&gt;=2.2.0-&gt;pytorch-lightning==1.6.4) (3.2.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="n">resnet18</span>

<span class="k">class</span> <span class="nc">ImageClassifier</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ImageClassifier</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="testing-the-forward-path-of-the-model">
<h3>Testing the forward path of the model<a class="headerlink" href="#testing-the-forward-path-of-the-model" title="Permalink to this headline">#</a></h3>
<p>As a trainable function, the model is callable. The model’s forward path (as defined in <code class="docutils literal notranslate"><span class="pre">forward()</span></code>) is the normal execution of the function. We can test this by passing an image to the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>  <span class="c1"># is the model callable?</span>
</pre></div>
</div>
</div>
</div>
<section id="what-is-a-valid-input">
<h4>What is a valid input?<a class="headerlink" href="#what-is-a-valid-input" title="Permalink to this headline">#</a></h4>
<p>To test the forward path of the model, we need to pass a valid input. The input should be a tensor of shape <code class="docutils literal notranslate"><span class="pre">(b,</span> <span class="pre">3,</span> <span class="pre">32,</span> <span class="pre">32)</span></code> where <code class="docutils literal notranslate"><span class="pre">b</span></code> is the batch size (an integer).</p>
<p><strong>Your Task</strong>: Fix the code below to pass the test.</p>
<p><strong>Tips:</strong> <code class="docutils literal notranslate"><span class="pre">torch.from_numpy()</span></code> can be used to convert a numpy array to a tensor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># TODO: The test is broken. Please fix it.</span>
<span class="k">def</span> <span class="nf">test_model_can_predict_on_a_random_image</span><span class="p">():</span>
    <span class="n">input_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>  <span class="c1"># run the model on the input image</span>
    <span class="k">assert</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># is the output shape correct?</span>


<span class="n">test_model_can_predict_on_a_random_image</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="step-2-prepare-the-dataset-and-data-loader">
<h2>Step 2: Prepare the dataset and data loader<a class="headerlink" href="#step-2-prepare-the-dataset-and-data-loader" title="Permalink to this headline">#</a></h2>
<p>Please reuse the <code class="docutils literal notranslate"><span class="pre">CustomDataset</span></code> and dataloader from the previous object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: copy over the code from the previous project.</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-training-the-model">
<h2>Step 3: Training the model<a class="headerlink" href="#step-3-training-the-model" title="Permalink to this headline">#</a></h2>
<section id="loss">
<h3>Loss<a class="headerlink" href="#loss" title="Permalink to this headline">#</a></h3>
<p>A loss is a function that takes the model’s output and the ground truth as input and returns a scalar value. The loss is used as the feedback mechantism to optimize the model.</p>
<p>For classification, the loss is typically the cross-entropy. Use <code class="docutils literal notranslate"><span class="pre">torch.nn.functional.cross_entropy</span></code> when the model output are logits or <code class="docutils literal notranslate"><span class="pre">torch.nn.functional.nll_loss</span></code> when the outputs are probabilities (a.k.a. softmax).</p>
<p><strong>Your Task</strong>: The following code almost works but there is a bug related to data type. Please fix it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="c1"># To simplify the code, assume there are 3 image classes.</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="nn">/Users/zzsi/projects/kungfu/kungfuu-computer-vision/course1-image-classification/p2_training.ipynb Cell 13</span> in <span class="ni">&lt;cell line: 6&gt;</span><span class="nt">()</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;vscode-notebook-cell:/Users/zzsi/projects/kungfu/kungfuu-computer-vision/course1-image-classification/p2_training.ipynb#ch0000020?line=3&#39;</span><span class="o">&gt;</span><span class="mi">4</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;vscode-notebook-cell:/Users/zzsi/projects/kungfu/kungfuu-computer-vision/course1-image-classification/p2_training.ipynb#ch0000020?line=4&#39;</span><span class="o">&gt;</span><span class="mi">5</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="n">y_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="o">----&gt;</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;vscode-notebook-cell:/Users/zzsi/projects/kungfu/kungfuu-computer-vision/course1-image-classification/p2_training.ipynb#ch0000020?line=5&#39;</span><span class="o">&gt;</span><span class="mi">6</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">))</span>

<span class="nn">File ~/opt/anaconda3/envs/kungfuu/lib/python3.8/site-packages/torch/nn/functional.py:3014,</span> in <span class="ni">cross_entropy</span><span class="nt">(input, target, weight, size_average, ignore_index, reduce, reduction, label_smoothing)</span>
<span class="g g-Whitespace">   </span><span class="mi">3012</span> <span class="k">if</span> <span class="n">size_average</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reduce</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">3013</span>     <span class="n">reduction</span> <span class="o">=</span> <span class="n">_Reduction</span><span class="o">.</span><span class="n">legacy_get_string</span><span class="p">(</span><span class="n">size_average</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">3014</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_nn</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">_Reduction</span><span class="o">.</span><span class="n">get_enum</span><span class="p">(</span><span class="n">reduction</span><span class="p">),</span> <span class="n">ignore_index</span><span class="p">,</span> <span class="n">label_smoothing</span><span class="p">)</span>

<span class="ne">RuntimeError</span>: expected scalar type Long but found Float
</pre></div>
</div>
</div>
</div>
<p><strong>Your Task</strong>: Can you make the loss lower? Try changing <code class="docutils literal notranslate"><span class="pre">y_pred</span></code> in the next cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: change y_pred to make the loss lower.</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="optimizer">
<h3>Optimizer<a class="headerlink" href="#optimizer" title="Permalink to this headline">#</a></h3>
<p>The gradient over model parameters (a.k.a. model weights) is computed of the loss function, and informs how the model parameters should be updated. The specifics of how the model is updated is handled by an optimizer.</p>
<p>An optimizer can be created by passing the model parameters (<code class="docutils literal notranslate"><span class="pre">model.parameters()</span></code>) to the optimizer constructor, as well as learning rate, momentum, and other hyper-parameters. Below is a minimal example of using an optimizer.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">LightningModule</span></code>, this is taken care of under the hood (pseudo-code):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># put model in train mode and enable gradient calculation</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">training_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">)</span>
    <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="c1"># clear gradients</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="c1"># backward</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># update parameters</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
<p>For more details, please refer to <a class="reference external" href="https://pytorch.org/docs/stable/optim.html">the documentation for PyTorch optimizers</a> and <a class="reference external" href="https://pytorch-lightning.readthedocs.io/en/stable/common/lightning_module.html">the documentation for <code class="docutils literal notranslate"><span class="pre">LightningModule</span></code></a>.</p>
</section>
<section id="training-step">
<h3>Training Step<a class="headerlink" href="#training-step" title="Permalink to this headline">#</a></h3>
<p>We can start specifying the training behavior to the model by adding the <code class="docutils literal notranslate"><span class="pre">training_step</span></code> method in the <code class="docutils literal notranslate"><span class="pre">ImageClassifier</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ImageClassifier</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Your task</strong>: Implement the following unit test. Use the data loader to get a batch of data.
Then, call the <code class="docutils literal notranslate"><span class="pre">training_step</span></code> and assert that the return value is a dictionary that looks
like this: <code class="docutils literal notranslate"><span class="pre">{'loss':</span> <span class="pre">0.5}</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_training_step_works</span><span class="p">():</span>
    <span class="c1"># TODO: Use the data loader to get a batch of data.</span>
    <span class="c1">#    Then, call the `training_step` and assert that the return value is a dictionary that looks</span>
    <span class="c1">#    like this: {&#39;loss&#39;: 0.5}.</span>
    <span class="o">...</span>


<span class="n">test_training_step_works</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="metrics">
<h3>Metrics<a class="headerlink" href="#metrics" title="Permalink to this headline">#</a></h3>
<p>A metric is a function that takes the model’s output and the ground truth as input and returns a scalar value. The metric is used to evaluate the model’s performance. It is mainly used to monitor the training progress and does not directly influence the model’s training behavior. However, it can influence model selection and early stopping.</p>
<p>For classification, the metric is typically the accuracy. We will use <code class="docutils literal notranslate"><span class="pre">torchmetrics.Accuracy</span></code> in this project.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchmetrics</span> <span class="kn">import</span> <span class="n">Accuracy</span>

<span class="c1"># Again, for simplicity, assume there are only 3 imge classes.</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="c1"># The following line is optional and shouldn&#39;t change the result.</span>
<span class="c1"># y_pred = F.softmax(y_pred, dim=1)</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">Accuracy</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">acc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy:&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accuracy: tensor(0.5000)
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-loop">
<h3>Training loop<a class="headerlink" href="#training-loop" title="Permalink to this headline">#</a></h3>
<p>A training loop manages the training process that iteratively passes batches of training examples to the model and running the training step.</p>
<p>The training steps are organized into “epochs”, where an epoch can be a single pass through the entire training dataset, or it can be simply a predefined number of training steps. At the end of an epoch, the model is used predict on the validation dataset and calculate accuracy metrics.</p>
<p>To do this, we need to add <code class="docutils literal notranslate"><span class="pre">validation_step</span></code> and <code class="docutils literal notranslate"><span class="pre">validation_epoch_end</span></code> methods and accuracy metrics to the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchmetrics</span> <span class="kn">import</span> <span class="n">Accuracy</span>


<span class="k">class</span> <span class="nc">ImageClassifier</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">Accuracy</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_accuracy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">preds</span><span class="o">=</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val_loss</span>
    
    <span class="k">def</span> <span class="nf">validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_accuracy</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;val_acc&#39;</span><span class="p">,</span> <span class="n">avg_acc</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-training">
<h3>Model training<a class="headerlink" href="#model-training" title="Permalink to this headline">#</a></h3>
</section>
</section>
<section id="visualize-model-predictions">
<h2>Visualize model predictions<a class="headerlink" href="#visualize-model-predictions" title="Permalink to this headline">#</a></h2>
<p>Having loss going down and accuracy going up is nice. But to have the peace of mind that the model is working and is indeed better, it is helpful to visualize the model’s predictions.</p>
<p><strong>Your Task</strong>: Complete the following cells to visualize the model’s predictions.</p>
<p>First, visualize predictions from a randomly initialized model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: call the un-trained model to predict on a few images from the validation set.</span>
<span class="c1">#   Use the skill learned in project 1 to display a batch of images.</span>
</pre></div>
</div>
</div>
</div>
<p>Next, take the trained model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: call the trained model to predict on a few images from the validation set.</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="p1_dataset.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Project 1: Preparing an image dataset for model training</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By KUNGFU.AI<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>